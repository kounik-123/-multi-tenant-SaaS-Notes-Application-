<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Notes Dashboard</h1>
                    <p class="text-sm text-gray-600" id="tenantInfo"></p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="userInfo"></span>
                    <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors duration-200">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Create Note Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Create New Note</h2>
            <form id="createNoteForm" class="space-y-4">
                <div>
                    <label for="noteTitle" class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="noteTitle" name="title" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter note title">
                </div>
                <div>
                    <label for="noteContent" class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                    <textarea id="noteContent" name="content" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Enter note content"></textarea>
                </div>
                <button type="submit" id="createBtn"
                        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform hover:scale-105 transition-all duration-200 flex items-center">
                    <span id="createText">Create Note</span>
                    <div id="createSpinner" class="hidden ml-2">
                        <div class="spinner"></div>
                    </div>
                </button>
            </form>
        </div>

        <!-- Subscription Limit Warning -->
        <div id="limitWarning" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md mb-6">
            <div class="flex items-center justify-between">
                <span>You've reached the free plan limit (3 notes). Upgrade to Pro for unlimited notes!</span>
                <a href="/upgrade" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 transition-colors duration-200">
                    Upgrade Now
                </a>
            </div>
        </div>

        <!-- Member: Pro Subscription Request Section -->
        <div id="subscriptionSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Pro Subscription</h2>
            <p class="text-gray-600 mb-4">Request a Pro subscription from your tenant admin.</p>
            <div class="flex items-center space-x-4">
                <button id="requestProBtn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors duration-200">
                    Request Pro Subscription
                </button>
                <span id="requestStatus" class="text-sm text-gray-600"></span>
            </div>
        </div>

        <!-- Admin: Tenant Requests List -->
        <div id="requestsSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">User Subscription Requests</h2>
                <button id="refreshRequestsBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1 rounded-md">Refresh</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
            <p id="noRequests" class="hidden text-sm text-gray-500 mt-3">No subscription requests yet.</p>
        </div>

        <!-- Notes List -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Your Notes</h2>
            </div>
            <div id="notesList" class="divide-y divide-gray-200">
                <!-- Notes will be loaded here -->
            </div>
            <div id="emptyState" class="hidden p-8 text-center text-gray-500">
                <p>No notes yet. Create your first note above!</p>
            </div>
            <div id="loadingNotes" class="p-8 text-center">
                <div class="spinner mx-auto"></div>
                <p class="mt-2 text-gray-500">Loading notes...</p>
            </div>
        </div>
    </div>

    <script>
        let user = null;
        let token = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');

            if (!token || !userData) {
                window.location.href = '/';
                return;
            }

            user = JSON.parse(userData);
            
            // Update UI with user info
            document.getElementById('tenantInfo').textContent = `${user.tenantName} (${user.subscriptionPlan.toUpperCase()} Plan)`;
            document.getElementById('userInfo').textContent = `${user.email} (${user.role})`;

            // Load notes
            loadNotes();

            // Init subscription UI (member/admin)
            initSubscriptionUI();
        });

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        // Create note form submission
        document.getElementById('createNoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const createBtn = document.getElementById('createBtn');
            const createText = document.getElementById('createText');
            const createSpinner = document.getElementById('createSpinner');

            // Show loading state
            createBtn.disabled = true;
            createText.textContent = 'Creating...';
            createSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ title, content })
                });

                const data = await response.json();

                if (response.ok) {
                    // Clear form
                    document.getElementById('createNoteForm').reset();
                    
                    // Reload notes
                    loadNotes();
                } else {
                    if (data.code === 'SUBSCRIPTION_LIMIT') {
                        document.getElementById('limitWarning').classList.remove('hidden');
                    }
                    throw new Error(data.error || 'Failed to create note');
                }
            } catch (error) {
                alert(error.message);
            } finally {
                // Reset loading state
                createBtn.disabled = false;
                createText.textContent = 'Create Note';
                createSpinner.classList.add('hidden');
            }
        });

        // Load notes function
        async function loadNotes() {
            const notesList = document.getElementById('notesList');
            const emptyState = document.getElementById('emptyState');
            const loadingNotes = document.getElementById('loadingNotes');

            try {
                const response = await fetch('/notes', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const notes = await response.json();

                loadingNotes.classList.add('hidden');

                if (notes.length === 0) {
                    emptyState.classList.remove('hidden');
                    notesList.innerHTML = '';
                } else {
                    emptyState.classList.add('hidden');
                    renderNotes(notes);
                }
            } catch (error) {
                console.error('Failed to load notes:', error);
                loadingNotes.classList.add('hidden');
            }
        }

        // Render notes function
        function renderNotes(notes) {
            const notesList = document.getElementById('notesList');
            
            notesList.innerHTML = notes.map(note => `
                <div class="note-item p-6 hover:bg-gray-50 transition-colors duration-200 opacity-0 transform translate-y-2" data-note-id="${note.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">${escapeHtml(note.title)}</h3>
                            <p class="text-gray-600 mb-3">${escapeHtml(note.content || 'No content')}</p>
                            <p class="text-sm text-gray-400">Created: ${new Date(note.created_at).toLocaleString()}</p>
                        </div>
                        <button onclick="deleteNote(${note.id})" 
                                class="ml-4 bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 transform hover:scale-105 transition-all duration-200">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');

            // Animate notes appearance
            setTimeout(() => {
                document.querySelectorAll('.note-item').forEach((item, index) => {
                    setTimeout(() => {
                        item.classList.remove('opacity-0', 'translate-y-2');
                        item.classList.add('opacity-100', 'translate-y-0');
                    }, index * 100);
                });
            }, 50);
        }

        // Delete note function
        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
            
            // Animate note removal
            noteElement.classList.add('opacity-0', 'transform', 'scale-95');

            try {
                const response = await fetch(`/notes/${noteId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    setTimeout(() => {
                        loadNotes();
                    }, 300);
                } else {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete note');
                }
            } catch (error) {
                alert(error.message);
                // Restore note appearance on error
                noteElement.classList.remove('opacity-0', 'scale-95');
            }
        }

        // Subscription UI logic
        async function initSubscriptionUI() {
            const isMember = user.role === 'member';
            const isAdmin = user.role === 'admin';
            const isFree = (user.subscriptionPlan || 'free') === 'free';

            const subscriptionSection = document.getElementById('subscriptionSection');
            const requestProBtn = document.getElementById('requestProBtn');
            const requestStatus = document.getElementById('requestStatus');

            const requestsSection = document.getElementById('requestsSection');
            const requestsTable = document.getElementById('requestsTable');
            const noRequests = document.getElementById('noRequests');
            const refreshRequestsBtn = document.getElementById('refreshRequestsBtn');

            // Toast helpers
            function showToast(message, type = 'info') {
                let toast = document.getElementById('toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = 'fixed top-4 right-4 z-50';
                    document.body.appendChild(toast);
                }
                const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-indigo-600';
                const el = document.createElement('div');
                el.className = `${color} text-white px-4 py-2 rounded shadow mb-2 animate-fade-in`;
                el.textContent = message;
                toast.appendChild(el);
                setTimeout(() => { el.remove(); }, 3000);
            }

            // Member view
            if (isMember && isFree) {
                subscriptionSection.classList.remove('hidden');

                // Load current status if any
                try {
                    const res = await fetch('/subscription-requests/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        updateMemberRequestUI(data.status);
                    } else if (res.status === 404) {
                        updateMemberRequestUI('none');
                    }
                } catch (e) {
                    console.warn('Could not load request status');
                }

                requestProBtn.addEventListener('click', async () => {
                    requestProBtn.disabled = true;
                    requestProBtn.textContent = 'Requesting...';
                    try {
                        const res = await fetch('/subscription-requests', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({})
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Failed to request');
                        updateMemberRequestUI(data.request.status);
                        showToast('Subscription request submitted (Pending).', 'info');
                    } catch (err) {
                        showToast(err.message, 'error');
                    } finally {
                        requestProBtn.disabled = false;
                        requestProBtn.textContent = 'Request Pro Subscription';
                    }
                });
            }

            function updateMemberRequestUI(status) {
                if (status === 'none') {
                    requestProBtn.classList.remove('hidden');
                    requestStatus.textContent = '';
                    return;
                }
                if (status === 'pending') {
                    requestStatus.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded bg-red-100 text-red-700">Pending</span>';
                    requestProBtn.classList.add('hidden');
                } else if (status === 'approved') {
                    requestStatus.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded bg-green-100 text-green-700">Approved</span>';
                    requestProBtn.classList.add('hidden');
                } else if (status === 'rejected') {
                    requestStatus.innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded bg-gray-200 text-gray-700">Rejected</span>';
                    requestProBtn.classList.remove('hidden');
                }
            }

            // Admin view
            if (isAdmin) {
                requestsSection.classList.remove('hidden');
                async function loadRequests() {
                    try {
                        const res = await fetch('/subscription-requests', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!res.ok) throw new Error('Failed to load requests');
                        const rows = await res.json();
                        renderRequests(rows);
                    } catch (e) {
                        console.error(e);
                        requestsTable.innerHTML = '';
                        noRequests.classList.remove('hidden');
                    }
                }

                function renderRequests(rows) {
                    if (!rows || rows.length === 0) {
                        requestsTable.innerHTML = '';
                        noRequests.classList.remove('hidden');
                        return;
                    }
                    noRequests.classList.add('hidden');
                    requestsTable.innerHTML = rows.map(r => `
                        <tr>
                            <td class="px-4 py-2 text-sm text-gray-700">${escapeHtml(r.user_email)}</td>
                            <td class="px-4 py-2 text-sm">
                                <span class="px-2 py-1 rounded text-white ${r.status === 'approved' ? 'bg-green-600' : r.status === 'rejected' ? 'bg-red-600' : 'bg-yellow-600'}">${r.status}</span>
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-500">${new Date(r.created_at).toLocaleString()}</td>
                            <td class="px-4 py-2 text-right">
                                ${r.status === 'pending' ? `
                                <button data-id="${r.id}" data-action="approve" class="mr-2 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Approve</button>
                                <button data-id="${r.id}" data-action="reject" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Reject</button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('');
                }

                requestsSection.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    const id = btn.getAttribute('data-id');
                    const action = btn.getAttribute('data-action');
                    btn.disabled = true;
                    btn.textContent = action === 'approve' ? 'Approving...' : 'Rejecting...';
                    try {
                        const res = await fetch(`/subscription-requests/${id}/${action}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                        if (!res.ok) {
                            const data = await res.json().catch(() => ({}));
                            throw new Error(data.error || 'Failed');
                        }
                        await loadRequests();
                        const msg = action === 'approve' ? 'Request approved. Upgraded to Pro.' : 'Request rejected.';
                        showToast(msg, 'success');
                        // For users, after approval they will no longer see the free limit (server-side handled)
                    } catch (err) {
                        showToast(err.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = action === 'approve' ? 'Approve' : 'Reject';
                    }
                });

                refreshRequestsBtn.addEventListener('click', loadRequests);
                loadRequests();
            }
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>